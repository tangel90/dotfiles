#!/usr/bin/env bash

if [[ $# -eq 1 ]]; then
    selected=$(command fd . "$1" -d 4 --type f --follow --hidden --exclude .git --no-ignore-vcs | fzf )
else
    selected=$(command fd . "$HOME" -d 8 --type f --follow --hidden --exclude .git --no-ignore-vcs | fzf )
fi

if [[ -z $selected ]]; then
    exit 0
fi

parent_dir=$(dirname "$selected")
first_parent=$(basename  "$parent_dir" | tr . _)
grandparent_dir=$(dirname "$parent_dir")
second_parent=$(basename "$grandparent_dir" | tr -d .)

file_name=$(basename  "$selected")
file_stem="${file_name%.*}"
window_name="${file_stem}"
alt_window_name="${window_name}_$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c2)" #Generate 2 random characters for duplicate names
tmux_running=$(pgrep tmux)

if [[ ! -z $TMUX ]]; then
    program="nvim"
    if [[ "$file_name" == *.csv || "$file_name" == *.tsv || "$file_name" == *.json ]]; then
        program="vd"
    fi
    if tmux list-windows | grep -Fxq "$window_name"; then
        window_name="${alt_window_name}"
    fi
    tmux new-window -n "$window_name" -c $parent_dir zsh -c "$program $file_name"
    # tmux select-window -t $window_name
    exit 0
fi

echo "Tmux not running! Instructions Unclear!"
