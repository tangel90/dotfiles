#!/usr/bin/env bash

LOGDIR=${LOGDIR:-/home/thomas/dev/logs}
export bluey_log_file="$LOGDIR/bluey_service.log"
export bingo_log_file="$LOGDIR/bingo_service.log"
export smorrebrod_log_file="$LOGDIR/smorrebrod_service.log"

SERVICES=(smorrebrod bluey prefect bingo)

if [[ $1 == "--list-services" || $1 == "ls" ]]; then
  printf "%s\n" "${SERVICES[@]}"
  exit 0
fi

service=$1

case $service in
  bluey)
    exec -a bluey-webservice python "/home/thomas/projects/DRP/bluey/main.py" 2>&1 | tee -a "$bluey_log_file" &
    ;;
  smorrebrod)
    exec -a smorrebrod-webservice python "$PROJECTS_HOME/DRP/smorrebrod-cloud/smorrebrod/main.py" 2>&1 | tee -a "$smorrebrod_log_file" &
    ;;
  prefect)
    if ! docker ps --filter "name=prefect-server" --filter "status=running" | grep -q prefect-server; then
      docker start prefect-server
      docker exec -d prefect-server prefect server start --host 0.0.0.0
    fi
    docker exec -it prefect-server /bin/bash
    ;;
  bingo)
    exec -a bingo-webservice streamlit run /home/thomas/projects/DRP/bingo/main.py 2>&1 | "$bingo_log_file" 2>&1 &
    ;;
  gonzo)
    exec -a gonzo-webservice python /home/thomas/projects/DRP/gonzo/main.py 2>&1
    ;;
  postgresql)
    sudo systemctl start postgresql.service
    ;;
  *)
    echo "Unknown service: $service"
    ;;
esac
